<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meine Sparwelt - Login & App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Laden der Firebase Module
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Exponiere die Imports und die initialisierten Variablen global f√ºr die Nutzung im Skript-Block
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
            getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp
        };
    </script>
    
    <script>
        // Setzt die Tailwind-Konfiguration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#4F46E5', // Hauptfarbe: Indigo
                        'secondary-green': '#10B981', // Akzentfarbe: Emerald
                        'accent-pink': '#EC4899', // Warnfarbe: Pink
                        'bg-light': '#F3F4F6', 
                        'card-light': '#FFFFFF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        };
    </script>
    <style>
        /* Grundlegendes Styling f√ºr das Handyformat */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6;
            display: flex;
            justify-content: center; 
            align-items: flex-start;
            min-height: 100vh;
            padding-bottom: 80px; 
        }
        #app-container {
            width: 100%;
            max-width: 500px; 
            min-height: 100vh;
            background-color: white;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.2); 
            position: relative;
        }

        /* Responsive Anpassung f√ºr Mobile */
        @media (max-width: 500px) {
            #app-container {
                max-width: 100%; 
                box-shadow: none; 
            }
            body {
                padding: 0; 
            }
        }
        
        /* Modals & Loader */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
        }

        .loader.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            color: #6B7280; /* Gray-500 */
            transition: color 0.2s;
            cursor: pointer;
        }

        .nav-item.active {
            color: #4F46E5; /* Primary-blue */
        }
        .nav-item:hover {
            color: #4F46E5;
        }
        .nav-item svg {
            transition: transform 0.2s;
        }
        .nav-item.active svg {
            transform: scale(1.1);
        }
    </style>
</head>
<body>

    <div id="app-container">
        
        <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col justify-center items-center z-50 transition-opacity duration-300 hidden">
            <div class="loader active border-primary-blue border-t-white border-2 w-10 h-10"></div>
            <p class="mt-4 text-white text-lg">Lade App...</p>
        </div>

        <div id="auth-view" class="p-8 flex flex-col justify-center items-center min-h-screen bg-bg-light">
            <h1 class="text-4xl font-extrabold text-primary-blue mb-2">Sparwelt</h1>
            <p class="text-gray-500 mb-8">Einloggen oder Registrieren</p>

            <div class="w-full max-w-sm bg-white p-6 rounded-xl shadow-2xl">
                <form id="auth-form" class="space-y-4">
                    <input type="email" id="auth-email" placeholder="E-Mail" required class="w-full p-3 rounded-lg border border-gray-300 focus:ring-primary-blue focus:border-primary-blue">
                    <input type="password" id="auth-password" placeholder="Passwort" required class="w-full p-3 rounded-lg border border-gray-300 focus:ring-primary-blue focus:border-primary-blue">
                    
                    <button type="submit" id="auth-submit-btn" class="w-full bg-primary-blue text-white py-3 rounded-xl font-bold hover:bg-indigo-600 transition flex items-center justify-center">
                        <span id="auth-btn-text">Anmelden</span>
                        <div class="loader ml-2" id="auth-loader"></div>
                    </button>
                    
                    <p id="auth-message" class="text-sm text-red-500 text-center"></p>
                </form>
                <div class="mt-4 text-center">
                    <button id="toggle-auth-mode" class="text-sm text-primary-blue hover:underline transition">
                        Noch kein Konto? Hier registrieren.
                    </button>
                    <p class="text-xs text-gray-400 mt-4 break-words">User ID: <span id="display-user-id">Wird geladen...</span></p>
                </div>
            </div>
        </div>

        <div id="main-app-view" class="min-h-screen hidden">
            <header id="app-header" class="bg-primary-blue text-white p-4 shadow-lg sticky top-0 z-10 flex justify-between items-center transition-all duration-300">
                <button onclick="goBack()" id="back-button" class="text-white hidden transition-all duration-300 transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
                <h1 id="header-title" class="text-xl font-bold transition-all duration-300 mx-auto">Dashboard</h1>
                <button onclick="handleLogout()" class="text-white text-sm hover:opacity-80 transition flex items-center">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 001 1h5a1 1 0 000-2H4V4h4a1 1 0 100-2H3zm13.36 8.36a1 1 0 00-1.41-1.41L12 12.59l-2.95-2.95a1 1 0 00-1.41 1.41l3.66 3.66a1 1 0 001.41 0l4.36-4.36z" clip-rule="evenodd" /></svg>
                     Logout
                 </button>
            </header>

            <main id="content" class="p-4 pb-24"></main>

            <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 max-w-[500px] mx-auto bg-white border-t border-gray-200 shadow-lg z-20 flex justify-around">
                <div class="nav-item active" data-view="dashboard" onclick="navigateTo('dashboard', null)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3 .895-3 2 1.343 2 3 2m0-8V4m0 12v4m-6-2h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                    <span class="text-xs mt-1">Sparschweine</span>
                </div>
                <div class="nav-item" data-view="budget" onclick="navigateTo('budget', null)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                    <span class="text-xs mt-1">Budget</span>
                </div>
            </nav>

            <div id="modal-container"></div>
        </div>
    </div>

    <script>
        // ** GLOBALE VARIABLEN (Von der Canvas-Umgebung bereitgestellt) **
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{apiKey: "AIzaSyCIFRKqBrugb_oHUWfxUnJa6UtgfZ2Aq3s",

    authDomain: "sparify-bd79e.firebaseapp.com",

    projectId: "sparify-bd79e",

    storageBucket: "sparify-bd79e.firebasestorage.app",

    messagingSenderId: "958598659366",

    appId: "1:958598659366:web:d53152dd669216415d15e7",

    measurementId: "G-XHH44C9LER"
}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // ** FIREBASE INITIALISIERUNG **
        let app, auth, db;
        let unsubscribeListeners = []; // Speichert alle onSnapshot Abonnements

        // ** ZUSTANDSVERWALTUNG **
        let userId = null;
        let isAuthReady = false;
        let currentView = 'dashboard';
        let selectedPiggyBankId = null; 

        // Echtzeit-Daten (entsprechen der Datenbankstruktur)
        let piggyBanks = []; // PhysicalPiggyBank
        let savingGoals = []; // SavingGoal
        let goalAllocations = []; // PiggyBankSavingGoal
        let transactions = []; // Transaction
        
        // Konstanten f√ºr Firebase Collection Namen
        const COLLECTIONS = {
            BANKS: 'piggyBanks',
            GOALS: 'savingGoals',
            ALLOCATIONS: 'piggyBankGoalAllocations',
            TRANSACTIONS: 'transactions'
        };

        // --- HILFSFUNKTIONEN F√úR DATENBANKPFADE ---
        /** Baut den Firestore Pfad f√ºr die PRIVATE Daten eines angemeldeten Benutzers. */
        const getCollectionPath = (collectionName) => {
            if (!userId) {
                console.error("User ID ist nicht verf√ºgbar. Kann keinen Pfad erstellen.");
                // Nutzt einen zuf√§lligen ID f√ºr anonyme oder nicht authentifizierte Zugriffe (wird im Auth-Teil behandelt)
                return `artifacts/${appId}/users/anonymous-temp/${collectionName}`; 
            }
            // Pfad: /artifacts/{appId}/users/{userId}/{collectionName}
            return `artifacts/${appId}/users/${userId}/${collectionName}`;
        };

        // --- AUTHENTIFIZIERUNG UND INITIALISIERUNG ---
        const setupFirebase = () => {
            if (!window.firebase) {
                console.error("Firebase Module nicht geladen.");
                showNotification("Firebase Module konnten nicht geladen werden.", 'error');
                return;
            }

            try {
                // App und Dienste initialisieren
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.getAuth(app);
                db = firebase.getFirestore(app);
            } catch (error) {
                console.error("Firebase Initialisierung fehlgeschlagen:", error);
                showNotification("Fehler bei der Initialisierung.", 'error');
                return;
            }

            // Auth State Listener
            firebase.onAuthStateChanged(auth, async (user) => {
                const loadingOverlay = document.getElementById('loading-overlay');
                loadingOverlay.classList.add('hidden'); // Blende das Laden-Overlay aus, sobald die Auth-Pr√ºfung beendet ist

                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Benutzer angemeldet:", userId);
                    document.getElementById('display-user-id').textContent = userId;
                    document.getElementById('auth-view').classList.add('hidden');
                    document.getElementById('main-app-view').classList.remove('hidden');
                    
                    // Starte die Echtzeit-Daten-Listener
                    startFirestoreListeners();
                } else {
                    userId = null;
                    isAuthReady = true;
                    console.log("Kein Benutzer angemeldet. Zeige Login.");
                    document.getElementById('display-user-id').textContent = 'ANONYM/NICHT EINGELOGGT';
                    document.getElementById('auth-view').classList.remove('hidden');
                    document.getElementById('main-app-view').classList.add('hidden');
                    
                    // Stoppe alle Listener, um Speicherlecks zu vermeiden
                    stopFirestoreListeners();
                }
            });
            
            // Initialen Token-Login versuchen (Canvas-spezifisch)
            if (initialAuthToken) {
                document.getElementById('loading-overlay').classList.remove('hidden');
                firebase.signInWithCustomToken(auth, initialAuthToken).catch(async (error) => {
                    console.warn("Custom Token Login fehlgeschlagen, versuche anonyme Anmeldung:", error.message);
                    // Fallback zur anonymen Anmeldung, falls der Token fehlschl√§gt
                    await firebase.signInAnonymously(auth).catch((anonError) => {
                         console.error("Anonyme Anmeldung fehlgeschlagen:", anonError.message);
                         showNotification("Fehler bei der Anmeldung. Bitte versuchen Sie es sp√§ter erneut.", 'error');
                    });
                });
            } else {
                 // Fallback zur anonymen Anmeldung, wenn kein Token verf√ºgbar ist
                 firebase.signInAnonymously(auth).catch((anonError) => {
                     console.error("Anonyme Anmeldung fehlgeschlagen:", anonError.message);
                     showNotification("Fehler bei der Anmeldung. Bitte versuchen Sie es sp√§ter erneut.", 'error');
                 });
            }

            // F√ºge Event Listener f√ºr das Auth Formular hinzu
            document.getElementById('auth-form').addEventListener('submit', handleAuthSubmit);
            document.getElementById('toggle-auth-mode').addEventListener('click', toggleAuthMode);
        };

        const handleLogout = async () => {
            try {
                await firebase.signOut(auth);
                // onAuthStateChanged wird den UI-Wechsel automatisch √ºbernehmen
                showNotification("Erfolgreich abgemeldet.", 'success');
            } catch (error) {
                console.error("Logout Fehler:", error);
                showNotification("Fehler beim Abmelden.", 'error');
            }
        };

        let isRegisterMode = false;
        const toggleAuthMode = () => {
            isRegisterMode = !isRegisterMode;
            const submitBtnText = document.getElementById('auth-btn-text');
            const toggleBtn = document.getElementById('toggle-auth-mode');
            
            if (isRegisterMode) {
                submitBtnText.textContent = 'Registrieren';
                toggleBtn.textContent = 'Bereits ein Konto? Hier anmelden.';
            } else {
                submitBtnText.textContent = 'Anmelden';
                toggleBtn.textContent = 'Noch kein Konto? Hier registrieren.';
            }
            document.getElementById('auth-message').textContent = '';
        };

        const handleAuthSubmit = async (event) => {
            event.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const messageEl = document.getElementById('auth-message');
            const loader = document.getElementById('auth-loader');
            const submitBtn = document.getElementById('auth-submit-btn');

            messageEl.textContent = '';
            loader.classList.add('active');
            submitBtn.disabled = true;

            try {
                if (isRegisterMode) {
                    await firebase.createUserWithEmailAndPassword(auth, email, password);
                    showNotification("Registrierung erfolgreich! Automatisch angemeldet.", 'success');
                } else {
                    await firebase.signInWithEmailAndPassword(auth, email, password);
                    showNotification("Anmeldung erfolgreich!", 'success');
                }
                // onAuthStateChanged √ºbernimmt den Rest
            } catch (error) {
                console.error("Auth Error:", error.code, error.message);
                let msg = "Ein unbekannter Fehler ist aufgetreten.";
                if (error.code === 'auth/email-already-in-use') msg = "Diese E-Mail ist bereits registriert.";
                else if (error.code === 'auth/invalid-email') msg = "Ung√ºltiges E-Mail-Format.";
                else if (error.code === 'auth/weak-password') msg = "Passwort muss mindestens 6 Zeichen lang sein.";
                else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') msg = "E-Mail oder Passwort ist falsch.";
                
                messageEl.textContent = msg;
            } finally {
                loader.classList.remove('active');
                submitBtn.disabled = false;
            }
        };


        // --- FIRESTORE DATENBANK LOGIK (Realtime & CRUD) ---
        
        // Stoppt alle onSnapshot Listener
        const stopFirestoreListeners = () => {
            unsubscribeListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeListeners = [];
            piggyBanks = [];
            savingGoals = [];
            goalAllocations = [];
            transactions = [];
        };

        // Startet alle onSnapshot Listener
        const startFirestoreListeners = () => {
            if (!db || !userId) {
                console.error("Firestore oder User nicht bereit.");
                return;
            }
            
            // 1. Sparschweine (PhysicalPiggyBank)
            const banksQuery = firebase.query(firebase.collection(db, getCollectionPath(COLLECTIONS.BANKS)));
            const unsubBanks = firebase.onSnapshot(banksQuery, (snapshot) => {
                piggyBanks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Sparschweine aktualisiert:", piggyBanks.length);
                updateUI(); // UI neu rendern bei Daten√§nderung
            }, (error) => console.error("Error fetching piggyBanks:", error));
            unsubscribeListeners.push(unsubBanks);

            // 2. Sparziele (SavingGoal)
            const goalsQuery = firebase.query(firebase.collection(db, getCollectionPath(COLLECTIONS.GOALS)));
            const unsubGoals = firebase.onSnapshot(goalsQuery, (snapshot) => {
                savingGoals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Sparziele aktualisiert:", savingGoals.length);
                updateUI();
            }, (error) => console.error("Error fetching savingGoals:", error));
            unsubscribeListeners.push(unsubGoals);
            
            // 3. Zuordnungen (PiggyBankSavingGoal)
            const allocationsQuery = firebase.query(firebase.collection(db, getCollectionPath(COLLECTIONS.ALLOCATIONS)));
            const unsubAllocations = firebase.onSnapshot(allocationsQuery, (snapshot) => {
                goalAllocations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Zuordnungen aktualisiert:", goalAllocations.length);
                updateUI();
            }, (error) => console.error("Error fetching goalAllocations:", error));
            unsubscribeListeners.push(unsubAllocations);

            // 4. Transaktionen (WICHTIG: Korrektur der Struktur, um das 'note' Feld aufzunehmen)
            const transactionsQuery = firebase.query(firebase.collection(db, getCollectionPath(COLLECTIONS.TRANSACTIONS)));
            const unsubTransactions = firebase.onSnapshot(transactionsQuery, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sortiere Transaktionen absteigend nach created_at 
                transactions.sort((a, b) => (b.created_at?.seconds || 0) - (a.created_at?.seconds || 0));
                console.log("Transaktionen aktualisiert:", transactions.length);
                updateUI();
            }, (error) => console.error("Error fetching transactions:", error));
            unsubscribeListeners.push(unsubTransactions);
            
            // Initiales Rendern
            updateUI();
        };

        // CRUD: Sparschwein hinzuf√ºgen
        const addPiggyBank = async (name, deviceId = 'MANUAL') => {
            try {
                const newBank = {
                    user_id: userId,
                    name: name,
                    current_amount: 0.00, // Initialwert
                    device_id: deviceId, // Setze den Ger√§tetyp/ID
                    created_at: firebase.serverTimestamp(),
                };
                await firebase.addDoc(firebase.collection(db, getCollectionPath(COLLECTIONS.BANKS)), newBank);
                showNotification(`Sparschwein "${name}" erstellt.`, 'success');
            } catch (error) {
                console.error("Fehler beim Hinzuf√ºgen des Sparschweins:", error);
                showNotification("Fehler beim Erstellen des Sparschweins.", 'error');
            }
        };

        // CRUD: Transaktion hinzuf√ºgen (Mit Korrektur f√ºr 'note' und Fokus auf piggybank_id)
        const addTransaction = async (bankId, type, amount, note) => {
             try {
                // ** WICHTIG: Transaktionen sind jetzt nur noch f√ºr 'withdrawal' relevant,
                // da 'deposit' als automatisch erfasst angenommen wird, aber die Funktion muss
                // die DB-Logik beibehalten.
                
                const newTransaction = {
                    user_id: userId,
                    piggybank_id: bankId, // FK -> PhysicalPiggyBank.id
                    amount: amount, // Betrag
                    type: type, // 'deposit' oder 'withdrawal'
                    note: note, // Optionaler Kommentar
                    created_at: firebase.serverTimestamp(),
                };
                await firebase.addDoc(firebase.collection(db, getCollectionPath(COLLECTIONS.TRANSACTIONS)), newTransaction);
                
                // Aktualisiere den Kontostand des Sparschweins
                const bankRef = firebase.doc(db, getCollectionPath(COLLECTIONS.BANKS), bankId);
                const delta = type === 'deposit' ? amount : -amount;
                
                // Holt den aktuellen Kontostand (sollte durch onSnapshot bereits aktuell sein)
                const currentBank = piggyBanks.find(b => b.id === bankId);
                if (currentBank) {
                     await firebase.updateDoc(bankRef, {
                        // Wichtig: toFixed(2) f√ºr saubere Gleitkomma-Berechnung
                        current_amount: parseFloat((currentBank.current_amount + delta).toFixed(2))
                    });
                }
                
                // ** HINWEIS: Hier m√ºsste sp√§ter die Logik zur Aufteilung auf Sparziele hin **
                // if (type === 'deposit') { runAllocationLogic(bankId, amount); }

                showNotification(`${type === 'deposit' ? '+' : '-'} ${formatCurrency(amount)} verbucht.`, 'success');

            } catch (error) {
                console.error("Fehler beim Hinzuf√ºgen der Transaktion:", error);
                showNotification("Fehler beim Verarbeiten der Transaktion.", 'error');
            }
        };


        // --- Hilfsfunktionen f√ºr Datenabruf (Client-seitig) ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(amount || 0);
        };

        // Formatiert den Firestore Timestamp in ein deutsches Datum
        const formatTimestamp = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'Unbekanntes Datum';
            return timestamp.toDate().toLocaleDateString('de-DE');
        };

        const getPiggyBank = (id) => piggyBanks.find(b => b.id === id);
        const getBankTransactions = (id) => transactions.filter(t => t.piggybank_id === id); // Bereits nach Datum sortiert
        const getBankGoals = (id) => {
            // Finde alle Ziel-IDs, die diesem Sparschwein zugeordnet sind
            const bankAllocation = goalAllocations.filter(a => a.piggybank_id === id);
            
            // Verkn√ºpfe die Sparziele mit den Zuordnungsinformationen
            return bankAllocation.map(allocation => {
                const goal = savingGoals.find(g => g.id === allocation.savinggoal_id);
                if (goal) {
                    return {
                        ...goal,
                        allocation_percent: allocation.allocation_percent,
                    };
                }
                return null;
            }).filter(g => g !== null);
        };
        

        // --- Navigationslogik & UI Update ---

        const updateNav = (activeView) => {
            document.querySelectorAll('.nav-item').forEach(item => {
                const itemView = item.getAttribute('data-view');
                const isActive = itemView === activeView || (activeView !== 'dashboard' && activeView !== 'budget' && item.getAttribute('data-view') === 'dashboard');
                item.classList.toggle('active', isActive);
            });
        };

        const updateUI = () => {
            if (!isAuthReady || !userId) {
                // Warte, bis der Auth-Status bekannt ist
                return;
            }
            
            const headerTitle = document.getElementById('header-title');
            const backButton = document.getElementById('back-button');
            const appHeader = document.getElementById('app-header');
            
            let title = '';
            let showBackButton = false;
            
            // Setze den Header f√ºr die aktuelle Ansicht
            if (currentView === 'dashboard') {
                title = 'Meine Sparwelt';
                showBackButton = false;
                appHeader.classList.add('bg-primary-blue');
                appHeader.classList.remove('shadow-none', 'bg-white');
                backButton.classList.remove('text-primary-blue');
                backButton.classList.add('text-white');
                headerTitle.classList.remove('text-gray-800');
                headerTitle.classList.add('text-white');
            } else if (currentView === 'budget') {
                title = 'Budget-Planer';
                showBackButton = false;
                appHeader.classList.add('bg-primary-blue');
                appHeader.classList.remove('shadow-none', 'bg-white');
                backButton.classList.remove('text-primary-blue');
                backButton.classList.add('text-white');
                headerTitle.classList.remove('text-gray-800');
                headerTitle.classList.add('text-white');
            } else {
                const bank = getPiggyBank(selectedPiggyBankId);
                title = currentView === 'details' ? (bank ? bank.name : 'Sparschwein Details') : 
                        currentView === 'goals' ? 'Sparziele verwalten' : 'Alle Aktivit√§ten';
                showBackButton = true;
                appHeader.classList.remove('bg-primary-blue'); 
                appHeader.classList.add('shadow-lg', 'bg-white');
                backButton.classList.remove('text-white');
                backButton.classList.add('text-primary-blue');
                headerTitle.classList.remove('text-white');
                headerTitle.classList.add('text-gray-800');
            }

            headerTitle.textContent = title;
            backButton.classList.toggle('hidden', !showBackButton);
            updateNav(currentView); 

            // Rendern des Inhalts
            switch (currentView) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'details':
                    renderPiggyBankDetails();
                    break;
                case 'goals':
                    renderGoals();
                    break;
                case 'transactions':
                    renderTransactions();
                    break;
                case 'budget':
                    renderBudgetPlanner(); // NEU
                    break;
                default:
                    renderDashboard();
            }
        };

        const goBack = () => {
            if (currentView === 'details') {
                currentView = 'dashboard';
                selectedPiggyBankId = null;
            } 
            else if (['goals', 'transactions'].includes(currentView)) {
                currentView = 'details';
            }
            updateUI();
        };
        
        const navigateTo = (view, id = null) => {
            if (id) selectedPiggyBankId = id;

            if (['goals', 'transactions'].includes(view) && !selectedPiggyBankId) {
                currentView = 'dashboard'; 
            } else {
                 currentView = view;
            }
            updateUI();
        };

        // --- View 1: Dashboard (Sparschweine) ---
        const renderDashboard = () => {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="p-2 pt-0">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">W√§hle dein Sparschwein</h2>
                    <div class="grid grid-cols-1 gap-4"> 
                        ${piggyBanks.map(bank => `
                            <div onclick="navigateTo('details', '${bank.id}')" 
                                 class="bg-card-light p-5 rounded-2xl shadow-xl border-b-4 border-primary-blue hover:shadow-2xl transition duration-300 transform hover:scale-[1.01] cursor-pointer">
                                <div class="flex items-center space-x-4">
                                    <span class="text-3xl bg-yellow-400 p-3 rounded-full shadow-md">üí∞</span>
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-800">${bank.name}</h3>
                                        <p class="text-3xl font-extrabold text-secondary-green mt-1">${formatCurrency(bank.current_amount)}</p>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-3 text-right">Tippen f√ºr √úbersicht</p>
                            </div>
                        `).join('')}
                        <div onclick="openModal('addPiggyBank')" class="bg-gray-100 p-5 rounded-2xl shadow-inner border-2 border-dashed border-gray-300 text-center hover:bg-gray-50 transition duration-300 cursor-pointer">
                            <div class="flex flex-col items-center justify-center h-full py-4">
                                <span class="text-4xl text-gray-400 mb-2">‚ûï</span>
                                <p class="text-lg font-semibold text-gray-500">Neues Sparschwein hinzuf√ºgen</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- View 2: Sparschwein Details ---
        const renderPiggyBankDetails = () => {
            const bank = getPiggyBank(selectedPiggyBankId);
            if (!bank) { navigateTo('dashboard'); return; }

            const transactionsList = getBankTransactions(bank.id).slice(0, 3); // Letzte 3
            const goalsList = getBankGoals(bank.id);
            
            let goalsHtml = goalsList.length > 0 ? goalsList.slice(0, 1).map(goal => {
                const percentage = (goal.current_amount / goal.target_amount) * 100;
                const allocationText = goal.allocation_percent ? `(${goal.allocation_percent}%)` : '';
                return `
                    <div class="mt-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-gray-700 truncate">${goal.name} ${allocationText}</span>
                            <span class="text-sm font-medium text-primary-blue">${formatCurrency(goal.current_amount)} / ${formatCurrency(goal.target_amount)}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full ${goal.color || 'bg-red-500'}" style="width: ${Math.min(100, percentage)}%"></div>
                        </div>
                    </div>
                `;
            }).join('') : '<p class="text-gray-500 italic text-sm">Noch keine Sparziele festgelegt.</p>';
            
            if (goalsList.length > 1) {
                 goalsHtml += `<p class="text-xs text-gray-500 mt-1">und ${goalsList.length - 1} weitere Ziele...</p>`;
            }

            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="text-center mb-6 p-6 bg-primary-blue rounded-b-3xl shadow-xl -mx-4 mt-[-1rem] text-white">
                    <p class="text-lg opacity-80">Aktuelles Guthaben</p>
                    <p class="text-5xl font-extrabold mt-1">${formatCurrency(bank.current_amount)}</p>
                    <p class="text-sm mt-2 opacity-80">Gespeichert in der Datenbank.</p>
                </div>

                <div class="grid grid-cols-1 gap-4 mb-8">
                    <button onclick="openModal('withdrawal')" class="flex flex-col items-center p-4 bg-accent-pink text-white rounded-xl shadow-lg hover:bg-pink-600 transition duration-200 transform hover:scale-[1.02] font-bold text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                        Auszahlung protokollieren
                    </button>
                    <p class="text-center text-sm text-gray-500">Einzahlungen werden automatisch √ºber den Ger√§te-Scan erfasst.</p>
                </div>

                <div onclick="navigateTo('goals', '${bank.id}')" class="bg-card-light p-5 rounded-xl shadow-md border-l-4 border-red-500 hover:bg-gray-50 cursor-pointer transition">
                    <h3 class="text-lg font-bold text-red-700 flex justify-between items-center">
                        üéØ Sparziele
                        <span class="text-sm font-medium text-red-500">${goalsList.length} Ziele</span>
                    </h3>
                    ${goalsHtml}
                </div>
                
                <div onclick="navigateTo('transactions', '${bank.id}')" class="bg-card-light p-5 rounded-xl shadow-md border-l-4 border-primary-blue mt-6 hover:bg-gray-50 cursor-pointer transition">
                    <h3 class="text-lg font-bold text-primary-blue flex justify-between items-center mb-3">
                        üìã Letzte Aktivit√§t
                        <span class="text-sm font-medium text-primary-blue hover:underline">Alle anzeigen</span>
                    </h3>
                    ${transactionsList.map(t => `
                        <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                            <div class="flex items-center space-x-3">
                                <span class="text-xl ${t.type === 'deposit' ? 'text-secondary-green' : 'text-accent-pink'}">${t.type === 'deposit' ? 'üü¢' : 'üî¥'}</span>
                                <div>
                                    <p class="font-medium text-gray-800 text-sm">${t.note || t.description || 'Kein Kommentar'}</p>
                                    <p class="text-xs text-gray-500">${formatTimestamp(t.created_at)}</p>
                                </div>
                            </div>
                            <span class="font-bold text-sm ${t.type === 'deposit' ? 'text-secondary-green' : 'text-accent-pink'}">
                                ${t.type === 'deposit' ? '+' : '-'} ${formatCurrency(t.amount)}
                            </span>
                        </div>
                    `).join('')}
                    ${transactionsList.length === 0 ? '<p class="text-center text-gray-500 italic text-sm">Noch keine Bewegungen vorhanden.</p>' : ''}
                </div>
            `;
        };

        // --- View 3: Sparziele verwalten ---
        const renderGoals = () => {
            const bank = getPiggyBank(selectedPiggyBankId);
            if (!bank) { navigateTo('dashboard'); return; }
            const bankGoals = getBankGoals(selectedPiggyBankId);
            const totalContribution = bankGoals.reduce((sum, g) => sum + (g.allocation_percent || 0), 0);

            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="flex justify-between items-center mb-6 pt-2">
                    <h2 class="text-xl font-bold text-gray-700">Sparziele f√ºr ${bank.name}</h2>
                    <button onclick="openModal('addGoal')" class="flex items-center bg-secondary-green text-white px-3 py-1 text-sm rounded-full shadow-md hover:bg-green-600 transition">
                        <span class="text-lg mr-1">+</span> Ziel
                    </button>
                </div>

                <div class="bg-card-light p-5 rounded-xl shadow-lg mb-6 text-center border-b-4 ${totalContribution > 100 ? 'border-red-500' : 'border-secondary-green'}">
                    <p class="text-xl font-extrabold ${totalContribution > 100 ? 'text-red-500' : 'text-secondary-green'}">${totalContribution}% Sparrate</p>
                    <p class="text-sm text-gray-500">Gesamt-Zuteilung von Einzahlungen auf dieses Sparschwein.</p>
                </div>

                <div class="grid grid-cols-1 gap-4"> 
                    ${bankGoals.map(goal => {
                        const percentage = Math.round((goal.current_amount / goal.target_amount) * 100);
                        return `
                            <div class="p-4 bg-card-light rounded-xl shadow-md border-l-4 border-red-500">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-lg font-bold text-gray-800">${goal.name}</p>
                                        <p class="text-sm text-gray-500">Beitrag: ${goal.allocation_percent}%</p>
                                    </div>
                                    <p class="text-xl font-extrabold text-red-500">${formatCurrency(goal.current_amount)}</p>
                                </div>
                                <div class="mt-3">
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div class="h-3 rounded-full ${goal.color || 'bg-red-500'}" style="width: ${Math.min(100, percentage)}%"></div>
                                    </div>
                                    <div class="flex justify-between text-xs mt-1 text-gray-500">
                                        <span>${percentage}% erreicht</span>
                                        <span class="font-medium">Ziel: ${formatCurrency(goal.target_amount)}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        };

        // --- View 4: Transaktionen ---
        const renderTransactions = () => {
            const bank = getPiggyBank(selectedPiggyBankId);
            if (!bank) { navigateTo('dashboard'); return; }
            const allTransactions = getBankTransactions(selectedPiggyBankId);

            const content = document.getElementById('content');
            content.innerHTML = `
                <h2 class="text-xl font-bold text-gray-700 mb-4 pt-2">Alle Bewegungen f√ºr ${bank.name}</h2>
                
                <div class="bg-card-light rounded-xl shadow-lg overflow-hidden max-h-[80vh]">
                    <div class="sticky top-0 bg-gray-100 flex justify-between p-3 font-semibold text-gray-600 text-sm border-b">
                        <span class="w-1/5">Datum</span>
                        <span class="w-2/5">Kommentar</span>
                        <span class="w-1/5">Typ</span>
                        <span class="w-1/5 text-right">Betrag</span>
                    </div>
                    <div class="divide-y divide-gray-100">
                        ${allTransactions.map(t => `
                            <div class="flex justify-between items-center p-3 hover:bg-gray-50 transition">
                                <span class="w-1/5 text-xs text-gray-500">${formatTimestamp(t.created_at)}</span>
                                <div class="w-2/5">
                                    <p class="font-medium text-gray-800 text-sm truncate">${t.note || 'Kein Kommentar'}</p>
                                </div>
                                <span class="w-1/5 text-xs font-medium ${t.type === 'deposit' ? 'text-secondary-green' : 'text-accent-pink'}">${t.type === 'deposit' ? 'Einzahlung' : 'Auszahlung'}</span>
                                <span class="w-1/5 text-right font-bold text-sm ${t.type === 'deposit' ? 'text-secondary-green' : 'text-accent-pink'}">
                                    ${t.type === 'deposit' ? '+' : '-'} ${formatCurrency(t.amount)}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ${allTransactions.length === 0 ? '<p class="text-center p-8 text-gray-500 italic">Noch keine Transaktionen vorhanden.</p>' : ''}
            `;
        };

        // --- View 5: Budgetplaner (NEU) ---
        const renderBudgetPlanner = () => {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="p-4 pt-2">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Budget-Planung (In Entwicklung)</h2>
                    <div class="bg-card-light p-6 rounded-xl shadow-lg text-center">
                        <span class="text-6xl mb-4 block">üóìÔ∏è</span>
                        <p class="text-lg font-semibold text-gray-700">Hier entsteht Ihr pers√∂nlicher Budget-Planer!</p>
                        <p class="text-sm text-gray-500 mt-2">Verfolgen Sie Ihre Einnahmen, Ausgaben und Sparziele auf Monatsbasis.</p>
                        <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                            <p class="text-sm font-medium text-yellow-800">Aktuelle Funktion: Nur Sparschweine & Ziele verf√ºgbar.</p>
                        </div>
                    </div>
                </div>
            `;
        };
        
        // --- Modal Logik ---
        const openModal = (type) => {
            const container = document.getElementById('modal-container');
            let modalContent = '';
            let title = '';
            let actionColor = 'bg-primary-blue';
            const bank = getPiggyBank(selectedPiggyBankId);
            
            if (type === 'withdrawal' && !bank) return;

            switch (type) {
                case 'withdrawal':
                    title = 'Geld abheben';
                    actionColor = 'bg-accent-pink';
                    modalContent = `
                        <form id="withdrawal-form" class="space-y-4">
                            <p class="text-gray-600 text-sm">Geld von Sparschwein "${bank.name}" abheben.</p>
                            <div>
                                <label for="withdrawal-amount" class="block text-sm font-medium text-gray-700">Betrag</label>
                                <input type="number" step="0.01" id="withdrawal-amount" name="withdrawal-amount" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-accent-pink focus:border-accent-pink" placeholder="z.B. 2.50">
                            </div>
                            <div>
                                <label for="withdrawal-note" class="block text-sm font-medium text-gray-700">Kommentar (Optional)</label>
                                <input type="text" id="withdrawal-note" name="withdrawal-note" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" placeholder="z.B. Eis gekauft">
                            </div>
                            <button type="submit" class="w-full ${actionColor} text-white py-3 rounded-xl font-bold hover:opacity-90 transition">Auszahlung best√§tigen</button>
                        </form>
                    `;
                    break;
                case 'addPiggyBank':
                    title = 'Neues Sparschwein hinzuf√ºgen';
                    actionColor = 'bg-primary-blue';
                    // NEUE MODAL-STRUKTUR MIT ZWEI OPTIONEN
                    modalContent = `
                        <p class="text-gray-600 mb-6 text-center">Wie m√∂chten Sie Ihr Sparschwein verbinden?</p>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="openModal('addBankManual')" class="flex flex-col items-center justify-center p-4 border-2 border-primary-blue text-primary-blue rounded-xl shadow-md hover:bg-primary-blue hover:text-white transition duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                <span class="font-bold text-sm">Manuell hinzuf√ºgen</span>
                            </button>
                            <button onclick="showNotification('QR-Code Scanner Funktion wird demn√§chst implementiert.', 'info')" class="flex flex-col items-center justify-center p-4 border-2 border-gray-400 text-gray-600 rounded-xl shadow-md hover:bg-gray-100 transition duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v.01M17 12h.01M10 12h.01M7 12h.01M19 19a2 2 0 01-2 2H7a2 2 0 01-2-2V7a2 2 0 012-2h10a2 2 0 012 2v10z" /></svg>
                                <span class="font-bold text-sm">Code/QR-Scan</span>
                            </button>
                        </div>
                    `;
                    break;
                case 'addBankManual': // Separate Ansicht f√ºr die manuelle Eingabe
                    title = 'Manuelles Sparschwein erstellen';
                    actionColor = 'bg-primary-blue';
                    modalContent = `
                        <form id="add-bank-manual-form" class="space-y-4">
                            <div>
                                <label for="bank-name-manual" class="block text-sm font-medium text-gray-700">Name des Sparschweins</label>
                                <input type="text" id="bank-name-manual" name="bank-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-primary-blue focus:border-primary-blue" placeholder="z.B. Mein Fahrrad-Fonds">
                            </div>
                            <button type="submit" class="w-full ${actionColor} text-white py-3 rounded-xl font-bold hover:opacity-90 transition">Sparschwein erstellen</button>
                        </form>
                    `;
                    break;
                case 'addGoal':
                    title = 'Neues Sparziel erstellen';
                    actionColor = 'bg-red-500';
                    modalContent = `
                        <form id="goal-form" class="space-y-4">
                            <div>
                                <label for="goal-name" class="block text-sm font-medium text-gray-700">Name des Ziels</label>
                                <input type="text" id="goal-name" name="goal-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-red-500 focus:border-red-500">
                            </div>
                            <div>
                                <label for="goal-target" class="block text-sm font-medium text-gray-700">Zielbetrag in EUR</label>
                                <input type="number" step="0.01" id="goal-target" name="goal-target" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-red-500 focus:border-red-500" placeholder="z.B. 400.00">
                            </div>
                            <div class="mt-6 p-3 bg-red-50 border border-red-200 rounded-lg">
                                <label for="goal-rate" class="block text-sm font-bold text-red-700">Zuteilungsrate auf Sparschwein (${bank.name}) in %</label>
                                <input type="number" id="goal-rate" name="goal-rate" min="0" max="100" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-red-500 focus:border-red-500" placeholder="z.B. 30">
                                <p class="text-xs text-red-500 mt-1">Dieser Anteil wird von Einzahlungen dieses Sparschweins dem Ziel gutgeschrieben.</p>
                            </div>
                            <button type="submit" class="w-full ${actionColor} text-white py-3 rounded-xl font-bold hover:opacity-90 transition">Ziel speichern</button>
                        </form>
                    `;
                    break;
                default:
                    return; 
            }

            // Modal HTML Struktur
            container.innerHTML = `
                <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity z-40" onclick="closeModal()"></div>
                <div id="modal" class="fixed inset-0 z-50 overflow-y-auto">
                    <div class="flex items-end sm:items-center justify-center min-h-full p-4 text-center sm:p-0">
                        <div class="relative bg-card-light rounded-xl shadow-2xl transform transition-all sm:my-8 sm:max-w-lg sm:w-full p-6 w-full">
                            <div class="flex justify-between items-center mb-4 border-b pb-3">
                                <h3 class="text-2xl font-extrabold text-gray-800">${title}</h3>
                                <button type="button" onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition">
                                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            ${modalContent}
                        </div>
                    </div>
                </div>
            `;
            
            // Event Listener f√ºr Formulare hinzuf√ºgen
            document.getElementById('modal-container').querySelector('form')?.addEventListener('submit', (e) => {
                e.preventDefault();
                // Unterscheide zwischen manuellem Hinzuf√ºgen und den anderen Formulartypen
                const formType = e.target.id === 'add-bank-manual-form' ? 'addBankManualSubmit' : type;
                handleFormSubmit(formType, e.target);
            });
        };

        const closeModal = () => {
            document.getElementById('modal-container').innerHTML = '';
        };

        // --- Formularverarbeitung ---
        const handleFormSubmit = async (type, form) => {
            let successMessage = 'Vorgang erfolgreich!';
            
            try {
                switch (type) {
                    case 'withdrawal':
                        const amount = parseFloat(form['withdrawal-amount'].value);
                        const note = form['withdrawal-note'].value;
                        if (isNaN(amount) || amount <= 0) throw new Error('Ung√ºltiger Betrag.');
                        
                        // √úberpr√ºfung auf ausreichend Guthaben
                        const bank = getPiggyBank(selectedPiggyBankId);
                        if (bank.current_amount < amount) throw new Error(`Nicht gen√ºgend Guthaben: ${formatCurrency(bank.current_amount)}.`);

                        // Transaktion als 'withdrawal' hinzuf√ºgen
                        await addTransaction(selectedPiggyBankId, 'withdrawal', amount, note);
                        break;
                        
                    case 'addBankManualSubmit': // Ge√§nderter Typ f√ºr das manuelle Formular
                        const bankName = form['bank-name'].value;
                        if (!bankName) throw new Error('Bitte geben Sie einen Namen ein.');
                        await addPiggyBank(bankName, 'MANUAL'); // 'MANUAL' als device_id setzen
                        break;

                    case 'addGoal':
                        const currentBank = getPiggyBank(selectedPiggyBankId);
                        if (!currentBank) throw new Error('Kein Sparschwein ausgew√§hlt.');

                        const goalName = form['goal-name'].value;
                        const goalTarget = parseFloat(form['goal-target'].value);
                        const goalRate = parseInt(form['goal-rate'].value);
                        
                        if (isNaN(goalTarget) || goalTarget <= 0 || isNaN(goalRate) || goalRate < 0 || goalRate > 100) throw new Error('Ung√ºltige Ziel-/Ratenwerte.');
                        
                        // 1. Speichere das Ziel (SavingGoal)
                        const goalRef = await firebase.addDoc(firebase.collection(db, getCollectionPath(COLLECTIONS.GOALS)), {
                            user_id: userId,
                            name: goalName,
                            target_amount: goalTarget,
                            current_amount: 0.00,
                            color: 'bg-' + ['blue', 'green', 'yellow', 'red', 'indigo'][Math.floor(Math.random() * 5)] + '-500', 
                            created_at: firebase.serverTimestamp(),
                        });
                        
                        // 2. Speichere die Zuordnung (PiggyBankSavingGoal)
                        await firebase.addDoc(firebase.collection(db, getCollectionPath(COLLECTIONS.ALLOCATIONS)), {
                            piggybank_id: selectedPiggyBankId,
                            savinggoal_id: goalRef.id,
                            allocation_percent: goalRate,
                            created_at: firebase.serverTimestamp(),
                        });
                        
                        successMessage = `Sparziel "${goalName}" mit ${goalRate}% Zuteilung erstellt.`;
                        break;
                    default:
                        throw new Error('Unbekannter Formulartyp.');
                }
                
                showNotification(successMessage, 'success');

            } catch (error) {
                console.error("Formularfehler:", error);
                showNotification(error.message, 'error');
            }

            closeModal();
            // updateUI wird durch den onSnapshot Listener ausgel√∂st
        };

        // --- Benachrichtigungsfunktion (Statt alert) ---
        const showNotification = (message, type = 'info') => {
            const container = document.getElementById('modal-container');
            const color = type === 'success' ? 'bg-secondary-green' : type === 'error' ? 'bg-red-500' : 'bg-primary-blue';
            
            const notification = document.createElement('div');
            notification.className = `${color} text-white p-4 rounded-xl shadow-xl fixed top-4 left-1/2 -translate-x-1/2 z-50 transition-all duration-300 transform scale-0 opacity-0 text-sm font-medium`;
            notification.textContent = message;

            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('scale-0', 'opacity-0');
                notification.classList.add('scale-100', 'opacity-100');
            }, 50);

            setTimeout(() => {
                notification.classList.remove('scale-100', 'opacity-100');
                notification.classList.add('scale-0', 'opacity-0');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        };


        // --- Initialisierung ---
        document.addEventListener('DOMContentLoaded', () => {
            // Zeige das Lade-Overlay, bis der Auth-Status gekl√§rt ist
            document.getElementById('loading-overlay').classList.remove('hidden'); 
            // Starte die gesamte Firebase-Logik
            setupFirebase();
        });

    </script>
</body>
</html>
